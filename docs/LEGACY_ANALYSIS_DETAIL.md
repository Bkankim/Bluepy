# Legacy 코드 상세 분석

**분석일**: 2025-10-17
**대상**: `legacy/infra/linux/자동점검 코드/점검자료분석/Linux_Check_2.py`
**총 라인**: 957줄

---

## 1. 전체 구조

### 1.1 파일 구성
```
[라인 1-12] 초기화 및 데이터 구조
[라인 14-62] 헬퍼 함수 (11개)
[라인 65-926] 점검 함수 (73개: _1SCRIPT ~ _73SCRIPT)
[라인 928-953] 실행 로직 (eval 기반 동적 호출)
```

### 1.2 데이터 흐름
```
report.txt 읽기
    ↓
"*******************************************" 구분자로 분할 (73개 섹션)
    ↓
각 섹션을 _XSCRIPT 함수에 전달
    ↓
결과 저장: excel_data, excel_data_dg, excel_data_hd
    ↓
report_excel.txt 저장
```

---

## 2. 헬퍼 함수 목록

| 함수명 | 기능 | 사용 빈도 |
|--------|------|-----------|
| `_NOSPACE(data)` | 리스트에서 빈 문자열 제거 | 매우 높음 (거의 모든 함수) |
| `_SPLIT(data)` | "----" 구분자로 데이터 분할 | 높음 (17회) |
| `_SETOK()` | 결과 GOOD (0) 저장 | 매우 높음 |
| `_SETBAD()` | 결과 BAD (1) 저장 | 매우 높음 |
| `_SETHOLD()` | 결과 HOLD (2) 저장 (수동 점검) | 중간 (18회) |
| `_SETHIGH()` | 심각도 HIGH (2) 저장 | 높음 (43회) |
| `_SETMID()` | 심각도 MID (1) 저장 | 중간 (16회) |
| `_SETLOW()` | 심각도 LOW (0) 저장 | 중간 (14회) |
| `_SETLINE()` | 줄바꿈 삽입 | 낮음 (6회) |
| `_HDDATA(pr)` | 추가 데이터 저장 | 중간 (15회) |
| `_DELGREP(data)` | grep 프로세스 제외 | 낮음 (1회) |

---

## 3. 73개 점검 함수 분석

### 3.1 함수 목록 (KISA 코드 매핑 추론)

| 함수명 | 줄수 | 복잡도 | 심각도 | 패턴 | KISA 코드 (추정) | 설명 (추정) |
|--------|------|--------|--------|------|------------------|-------------|
| `_1SCRIPT` | 14 | 중 | HIGH | PAM 설정 검증 | U-01 | root 원격 로그인 제한 |
| `_2SCRIPT` | 4 | 낮음 | HIGH | 자동 OK | U-02 | 패스워드 복잡도 (Shadow 파일 해시화) |
| `_3SCRIPT` | 15 | 중 | HIGH | PAM 설정 검증 | U-03 | 계정 잠금 임계값 설정 |
| `_4SCRIPT` | 6 | 매우 낮음 | HIGH | 간단한 조건문 | U-04 | Shadow 패스워드 사용 |
| `_5SCRIPT` | 8 | 낮음 | MID | UID 검증 | U-05 | UID 중복 금지 |
| `_6SCRIPT` | 13 | 중 | LOW | PAM 설정 + HDDATA | U-06 | root 계정 su 제한 |
| `_7SCRIPT` | 7 | 낮음 | MID | 숫자 비교 | U-07 | 패스워드 최소 길이 설정 |
| `_8SCRIPT` | 7 | 낮음 | MID | 숫자 비교 | U-08 | 패스워드 최대 사용 기간 |
| `_9SCRIPT` | 7 | 낮음 | MID | 숫자 비교 | U-09 | 패스워드 최소 사용 기간 |
| `_10SCRIPT` | 9 | 낮음 | LOW | 데이터 수집 (HOLD) | U-10 | 불필요한 계정 존재 확인 |
| `_11SCRIPT` | 10 | 중 | LOW | try-except + HDDATA | U-11 | 동일 UID 금지 |
| `_12SCRIPT` | 8 | 낮음 | LOW | 데이터 수집 (HOLD) | U-12 | 사용자 Shell 점검 |
| `_13SCRIPT` | 11 | 중 | MID | 중복 검증 | U-13 | UID 중복 검증 |
| `_14SCRIPT` | 9 | 중 | LOW | Shell 경로 검증 | U-14 | 사용자 Shell 제한 |
| `_15SCRIPT` | 13 | 중 | LOW | 환경변수 검증 | U-15 | Session Timeout 설정 |
| `_16SCRIPT` | 8 | 낮음 | HIGH | '.' 검증 | U-16 | root 홈/Path에 '.' 포함 금지 |
| `_17SCRIPT` | 9 | 낮음 | HIGH | 빈 데이터 검증 | U-17 | 파일/디렉토리 소유자 설정 |
| `_18SCRIPT` | 10 | 중 | HIGH | 권한 파싱 | U-18 | /etc/passwd 권한 설정 |
| `_19SCRIPT` | 9 | 중 | HIGH | 권한 파싱 | U-19 | /etc/shadow 권한 설정 |
| `_20SCRIPT` | 9 | 중 | HIGH | 권한 파싱 | U-20 | /etc/hosts 권한 설정 |
| `_21SCRIPT` | 9 | 중 | HIGH | 권한 파싱 | U-21 | /etc/xinetd.conf 권한 설정 |
| `_22SCRIPT` | 9 | 중 | HIGH | 권한 파싱 | U-22 | /etc/syslog.conf 권한 설정 |
| `_23SCRIPT` | 9 | 중 | HIGH | 권한 파싱 | U-23 | /etc/services 권한 설정 |
| `_24SCRIPT` | 9 | 중 | HIGH | 데이터 수집 (HOLD) | U-24 | /dev에 존재하지 않아야 할 파일 점검 |
| `_25SCRIPT` | 6 | 매우 낮음 | HIGH | 미구현 (HOLD) | U-25 | 추가 요망 |
| `_26SCRIPT` | 11 | 중 | HIGH | 심볼릭 링크 파싱 | U-26 | $HOME/.rhosts, hosts.equiv 점검 |
| `_27SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-27 | 접속 IP/포트 제한 |
| `_28SCRIPT` | 13 | 높음 | HIGH | 복잡한 조건 | U-28 | hosts.lpd 파일 점검 |
| `_29SCRIPT` | 21 | 높음 | HIGH | 복잡한 조건 | U-29 | NIS 서비스 점검 |
| `_30SCRIPT` | 9 | 중 | LOW | 권한 파싱 | U-30 | tftp 서비스 확인 |
| `_31SCRIPT` | 12 | 중 | MID | 데이터 수집 (HOLD) | U-31 | Daemon 점검 |
| `_32SCRIPT` | 14 | 중 | MID | umask 검증 | U-32 | 계정 umask 설정 |
| `_33SCRIPT` | 6 | 매우 낮음 | MID | 미구현 (HOLD) | U-33 | 추가 요망 |
| `_34SCRIPT` | 11 | 중 | MID | 데이터 수집 (HOLD) | U-34 | 홈 디렉토리 점검 |
| `_35SCRIPT` | 7 | 매우 낮음 | LOW | 미구현 (HOLD) | U-35 | 추가 요망 |
| `_36SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-36 | r 계열 서비스 비활성화 |
| `_37SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-37 | cron 접근 제어 |
| `_38SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-38 | 로그온 시 경고 메시지 |
| `_39SCRIPT` | 8 | 중 | HIGH | 권한 파싱 | U-39 | NFS 설정 파일 점검 |
| `_40SCRIPT` | 10 | 중 | HIGH | 빈 데이터 검증 (_SPLIT) | U-40 | expn, vrfy 명령어 제한 |
| `_41SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-41 | 웹 서비스 정보 숨김 |
| `_42SCRIPT` | 10 | 중 | ? | grep 제거 후 검증 | U-42 | 웹 서비스 프로세스 권한 |
| `_43SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-43 | 웹 서비스 Link 금지 |
| `_44SCRIPT` | 13 | 중 | HIGH | grep 제외 검증 | U-44 | 웹 서비스 파일 업로드/다운로드 |
| `_45SCRIPT` | 13 | 중 | HIGH | grep 제외 검증 | U-45 | 웹 서비스 설정 파일 |
| `_46SCRIPT` | 11 | 중 | HIGH | grep 제외 검증 | U-46 | 웹 서비스 디렉토리 리스팅 |
| `_47SCRIPT` | 10 | 중 | HIGH | 데이터 수집 (HOLD) | U-47 | Sendmail 버전 점검 |
| `_48SCRIPT` | 13 | 높음 | HIGH | 복잡한 조건 | U-48 | 스팸 메일 릴레이 제한 |
| `_49SCRIPT` | 11 | 중 | HIGH | 빈 데이터 검증 | U-49 | 일반 사용자 Sendmail 실행 방지 |
| `_50SCRIPT` | 12 | 중 | HIGH | 데이터 수집 (HOLD) | U-50 | DNS 보안 버전 패치 |
| `_51SCRIPT` | 9 | 중 | HIGH | 데이터 수집 (HOLD) | U-51 | DNS Zone Transfer 설정 |
| `_52SCRIPT` | 11 | 중 | HIGH | 문자열 검증 | U-52 | Apache 디렉토리 리스팅 제거 |
| `_53SCRIPT` | 11 | 중 | HIGH | 문자열 검증 | U-53 | Apache 웹 프로세스 권한 |
| `_54SCRIPT` | 10 | 중 | HIGH | 문자열 검증 | U-54 | Apache 웹 서비스 링크 금지 |
| `_55SCRIPT` | 10 | 중 | HIGH | 빈 데이터 검증 (_SPLIT) | U-55 | Apache 파일 업로드/다운로드 제한 |
| `_56SCRIPT` | 10 | 중 | HIGH | 문자열 검증 | U-56 | Apache 웹 서비스 영역 분리 |
| `_57SCRIPT` | 17 | 높음 | HIGH | 숫자 파싱 + try-except | U-57 | 웹 서비스 파일 업로드 크기 제한 |
| `_58SCRIPT` | 8 | 낮음 | HIGH | 빈 데이터 검증 | U-58 | 웹 서비스 불필요한 파일 제거 |
| `_59SCRIPT` | 8 | 낮음 | MID | 문자열 검증 | U-59 | telnet, ftp 서비스 비활성화 |
| `_60SCRIPT` | 18 | 높음 | LOW | 복잡한 조건 | U-60 | ftp 계정 점검 |
| `_61SCRIPT` | 13 | 중 | MID | Shell 경로 검증 | U-61 | ftp 계정 Shell 제한 |
| `_62SCRIPT` | 14 | 중 | LOW | 권한 파싱 | U-62 | ftpusers 파일 점검 |
| `_63SCRIPT` | 10 | 중 | MID | 빈 데이터 검증 + HDDATA | U-63 | ftp root 계정 접속 차단 |
| `_64SCRIPT` | 17 | 중 | MID | 권한 파싱 | U-64 | ftp 설정 파일 권한 |
| `_65SCRIPT` | 9 | 낮음 | MID | 문자열 검증 | U-65 | SNMP 서비스 점검 |
| `_66SCRIPT` | 13 | 중 | MID | 문자열 검증 | U-66 | SNMP Community String 복잡도 |
| `_67SCRIPT` | 8 | 낮음 | LOW | 역조건 검증 | U-67 | 로그온 시 경고 메시지 표시 |
| `_68SCRIPT` | 11 | 중 | MID | 권한 파싱 | U-68 | NFS 설정 파일 권한 |
| `_69SCRIPT` | 9 | 중 | MID | 데이터 수집 (HOLD) | U-69 | expn, vrfy 명령어 제한 |
| `_70SCRIPT` | 11 | 중 | MID | 문자열 검증 | U-70 | Apache 웹 서비스 정보 숨김 |
| `_71SCRIPT` | 7 | 매우 낮음 | HIGH | 데이터 수집 (HOLD) | U-71 | 최신 패치 및 업데이트 적용 |
| `_72SCRIPT` | 5 | 매우 낮음 | HIGH | 데이터 수집 (HOLD) | U-72 | 로그의 정기적 검토 및 보고 |
| `_73SCRIPT` | 7 | 매우 낮음 | LOW | 데이터 수집 (HOLD) | U-73 | 정책에 따른 시스템 로깅 설정 |

### 3.2 복잡도 분류

| 복잡도 | 개수 | 함수 번호 |
|--------|------|-----------|
| 매우 낮음 (1-5줄) | 8개 | _2, _25, _33, _35, _71, _72, _73 + 기타 |
| 낮음 (6-8줄) | 32개 | _4, _5, _7, _8, _9, _15, _16, _17, _27, _36, _37, _38, _41, _43, _58, _59, _65, _67 등 |
| 중 (9-14줄) | 28개 | _1, _3, _6, _11, _13, _14, _18, _19, _20, _21, _22, _23, _24, _26, _30, _31, _32, _34, _39, _40, _42 등 |
| 높음 (15줄+) | 5개 | _28, _29, _48, _57, _60 |

### 3.3 패턴 분류

| 패턴 | 개수 | 특징 |
|------|------|------|
| 빈 데이터 검증 | 22개 | `if data==[]: _SETOK()` |
| 권한 파싱 | 15개 | 파일 권한 문자열 슬라이싱 (r[1:10]) |
| 문자열 검증 | 12개 | `if 'keyword' in data` |
| PAM 설정 검증 | 3개 | PAM 설정 파일 파싱 |
| 데이터 수집 (HOLD) | 13개 | `_SETHOLD()` + `_HDDATA()` |
| 숫자 비교 | 6개 | `int()` 변환 후 비교 |
| 미구현 | 3개 | _25, _33, _35 (주석: "추가 요망") |

---

## 4. Python 2 구문 사용 현황

| 구문 | 개수 | 위치 |
|------|------|------|
| `print` 문 (함수 아님) | 92회 | 모든 _XSCRIPT 함수의 START/END |
| `except:` (bare except) | 3회 | 라인 60, 133, 939 |
| `with open() as f:` 미종료 | 1회 | 라인 3-7 (f.closed로 종료 시도) |
| `.split()` 과다 사용 | 매우 많음 | 거의 모든 함수 |

---

## 5. 인코딩 관련

- **파일 인코딩**: BOM-UTF8 (라인 1에 BOM 존재)
- **한글 주석**: 4개 (라인 82, 335, 444, 462: "추가 요망", 814: "FTP root 계정 접속 차단 확인" 등)
- **한글 문자열**: _HDDATA에 포함 (라인 908, 916, 923)

---

## 6. 10개 함수 선정 (마이그레이션 대상)

### 6.1 선정 기준
1. 복잡도가 낮거나 중간인 것
2. 다양한 패턴 포함 (권한 파싱, 빈 데이터 검증, 숫자 비교, PAM 설정, HOLD)
3. KISA U-01 ~ U-10 (계정 관리 위주)
4. 미구현(_25, _33, _35) 제외

### 6.2 선정 결과

| 순위 | 함수 | KISA | 복잡도 | 심각도 | 패턴 | 선정 이유 |
|------|------|------|--------|--------|------|-----------|
| 1 | `_4SCRIPT` | U-04 | 매우 낮음 | HIGH | 간단한 조건문 | 가장 간단, 시작하기 좋음 |
| 2 | `_7SCRIPT` | U-07 | 낮음 | MID | 숫자 비교 | 데이터 파싱 패턴 |
| 3 | `_8SCRIPT` | U-08 | 낮음 | MID | 숫자 비교 | 비슷한 패턴 반복 |
| 4 | `_9SCRIPT` | U-09 | 낮음 | MID | 숫자 비교 | 비슷한 패턴 반복 |
| 5 | `_5SCRIPT` | U-05 | 낮음 | MID | UID 검증 | 배열 접근 패턴 |
| 6 | `_18SCRIPT` | U-18 | 중 | HIGH | 권한 파싱 | 권한 파싱 대표 패턴 |
| 7 | `_27SCRIPT` | U-27 | 낮음 | HIGH | 빈 데이터 검증 | 빈 데이터 검증 대표 패턴 |
| 8 | `_1SCRIPT` | U-01 | 중 | HIGH | PAM 설정 검증 | 복잡한 조건문, _SPLIT 사용 |
| 9 | `_3SCRIPT` | U-03 | 중 | HIGH | PAM 설정 검증 | 배열 조건 검증 |
| 10 | `_10SCRIPT` | U-10 | 낮음 | LOW | 데이터 수집 (HOLD) | HOLD 패턴, _HDDATA 사용 |

---

## 7. 마이그레이션 전략

### 7.1 자동 변환 가능
- `print "X"` → `print("X")`
- `except:` → `except Exception:`
- BOM 제거
- shebang 업데이트

### 7.2 수동 작업 필요
- 함수 추출 (AST 기반)
- bash 명령어 추출 (현재 코드에는 없음, report.txt에 있을 것으로 추정)
- KISA 코드 매핑 (함수 번호 기반 추정)
- YAML 규칙 생성
- Validator 함수 스켈레톤 생성

### 7.3 주의사항
- `_SPLIT()`, `_NOSPACE()` 같은 헬퍼 함수는 validator에서 재사용하지 않음 (Clean Architecture)
- `eval()` 기반 실행은 제거 (Scanner 엔진이 YAML을 읽고 validator 직접 호출)
- HOLD 패턴은 CheckResult(status="MANUAL")로 변환

---

## 8. 다음 단계

1. **Task 1.2**: 10개 함수 선정 완료 (위 표 참조)
2. **Task 1.3-1.4**: CheckResult, RuleMetadata 도메인 모델 설계 및 구현
3. **Task 1.5**: YAML 스키마 확정
4. **Task 1.6**: 마이그레이션 전략 문서 (이 문서가 기초 자료)

---

**문서 끝**
